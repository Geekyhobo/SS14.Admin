@using SS14.Admin.Helpers
@using SS14.Admin.Services
@using Content.Server.Database
@using Microsoft.EntityFrameworkCore
@inherits LayoutComponentBase
@implements IDisposable

@inject ClientPreferencesService ClientPreferences

<div class="@(_clientPreferences.darkMode ? "dark" : "")">

    <header class="Header flex gap-x-8 p-2 pl-0 items-center sticky top-0 bg-primary-1 header-height z-20 pl-2">
        <img class="m-3 h-9 md:block" src="https://wiki.spacestation14.io/w/images/logo.svg" alt="space station 14 logo">
        <h1 class="sr-only">space station 14 admin panel</h1>
        <div class="sm:flex focus-outline items-center h-9 border dark:border-neutral-400 px-2 rounded-full">
            <div class="ri-search-line text-lg text-primary-1"></div>
            <input type="text" class="border-none h-6 appearance-none focus-none !bg-transparent text-muted-1" placeholder="Search" />
        </div>
        <Breadcrumbs />
        <div class="grow"></div>
        <div class="mr-3 flex gap-x-2 items-center">
            <QuickLinksDropdown />
            <div class="flex flex-col gap-0">
                <NavLink href="/settings" class="font-semibold text-link-1 leading-tight">@adminUsername</NavLink>
                @if (!string.IsNullOrEmpty(adminSubtitle))
                {
                    <span class="text-xs text-muted-1 leading-tight">@adminSubtitle</span>
                }
            </div>
            <NavLink href="/Login/Logout" class="text-link-1">Logout</NavLink>
            <!--<img class="rounded-full h-8 w-8" height="32" alt="@placeholder" src="https://i.pravatar.cc/32" width="32">-->
        </div>
        <div class="flex gap-x-2">
            <PiiToggle />
            <DarkModeToggle />
        </div>
    </header>

    <div class="flex h-full-content bg-secondary-1">
        <NavMenu />
        <CascadingValue Value="Breadcrumbs">
            <main class="basis-full pt-6 p-8 m-2 rounded overflow-auto bg-primary-1">
                <div class="flex w-full h-full gap-4 flex-col">
                    @Body
                </div>
            </main>
        </CascadingValue>
    </div>

    <div id="blazor-error-ui" class="bg-errorBg text-errorText">
        An unhandled error has occurred.
        <a href="" class="text-link">Reload</a>
        <a class="text-textSecondary">ðŸ—™</a>
    </div>

</div>

@code
{
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    [Inject]
    private IDbContextFactory<PostgresServerDbContext>? ContextFactory { get; set; }

    private string adminUsername = string.Empty;
    private string adminSubtitle = string.Empty;

    public List<Breadcrumb> Breadcrumbs = [];

    private ClientPreferencesService.ClientPreferences _clientPreferences;

    protected override async Task OnInitializedAsync()
    {
        ClientPreferences.OnChange += OnChange;
        var authState = await AuthState!;
        var user = authState.User;
        adminUsername = user.Identity?.Name ?? string.Empty;

        // Little bit of fun to show the admin title
        var userId = user.Claims.GetUserId();

        await using var context = await ContextFactory!.CreateDbContextAsync();
        var adminData = await context.Admin
            .Include(a => a.AdminRank)
            .AsNoTracking()
            .FirstOrDefaultAsync(a => a.UserId == userId);

        if (adminData != null)
        {
            if (!string.IsNullOrEmpty(adminData.Title))
            {
                adminSubtitle = adminData.Title;
            }
            else if (adminData.AdminRank != null)
            {
                adminSubtitle = adminData.AdminRank.Name;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _clientPreferences = await ClientPreferences.GetClientPreferences();
            StateHasChanged();
        }
    }

    private void OnChange(ClientPreferencesService.ClientPreferences clientPreferences)
    {
        _clientPreferences = clientPreferences;
        StateHasChanged();
    }

    public void Dispose()
    {
        ClientPreferences.OnChange -= OnChange;
    }
}
