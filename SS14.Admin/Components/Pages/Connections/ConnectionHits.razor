@page "/connections/{ConnectionId:int}/hits"
@using Microsoft.AspNetCore.Components.QuickGrid

<PageTitle>Connection Ban Hits</PageTitle>

<div class="container mx-auto px-4 py-6">
    @if (Connection != null)
    {
        <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-gray-100">Bans Hit for Connection #@Connection.Id</h1>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">Username:</dt>
                    <dd class="text-base text-gray-900 dark:text-gray-100 mt-1">@Connection.UserName</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">User ID:</dt>
                    <dd class="text-base font-mono text-gray-900 dark:text-gray-100 mt-1">@Connection.UserId</dd>
                </div>
                @if (ShowPII)
                {
                    <div>
                        <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">IP:</dt>
                        <dd class="text-base font-mono text-gray-900 dark:text-gray-100 mt-1">@Connection.Address</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">HWID:</dt>
                        <dd class="text-base font-mono text-gray-900 dark:text-gray-100 mt-1">@Connection.HWId</dd>
                    </div>
                }
                <div>
                    <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">Connection Time:</dt>
                    <dd class="text-base text-gray-900 dark:text-gray-100 mt-1">@Connection.Time.ToString("yyyy-MM-dd HH:mm:ss")</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">Server:</dt>
                    <dd class="text-base text-gray-900 dark:text-gray-100 mt-1">@Connection.ServerName</dd>
                </div>
                <div>
                    <dt class="text-sm font-semibold text-gray-600 dark:text-gray-400">Status:</dt>
                    <dd class="text-base text-gray-900 dark:text-gray-100 mt-1">
                        @if (Connection.Denied.HasValue)
                        {
                            <span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded text-sm font-medium">
                                @Connection.Denied.Value.ToString()
                            </span>
                        }
                        else
                        {
                            <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-sm font-medium">
                                Accepted
                            </span>
                        }
                    </dd>
                </div>
            </dl>
        </div>

        <div class="mb-4">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Bans Hit</h2>

            <div class="mb-4">
                <input type="text"
                       @bind="_searchText"
                       @bind:event="oninput"
                       placeholder="Search bans..."
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-100" />
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <QuickGrid TItem="BanHitViewModel"
                       @ref="Grid"
                       Items="@GetFilteredBans()"
                       Pagination="@_pagination"
                       Class="w-full">
                <PropertyColumn Property="@(b => b.PlayerName)" Title="Player Name" Sortable="true" Class="text-primary-1" />
                <PropertyColumn Property="@(b => b.PlayerUserId)" Title="User ID" Sortable="true" Class="text-primary-1" />
                @if (ShowPII)
                {
                    <PropertyColumn Property="@(b => b.IPAddress)" Title="IP Address" Class="text-primary-1" />
                    <PropertyColumn Property="@(b => b.Hwid)" Title="HWID" Class="text-primary-1" />
                }
                <PropertyColumn Property="@(b => b.Reason)" Title="Reason" Class="text-primary-1" />
                <PropertyColumn Property="@(b => b.BanTime)" Title="Ban Time" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" Class="text-primary-1" />
                <PropertyColumn Property="@(b => b.ExpirationTime)" Title="Expires" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" Class="text-primary-1" />
                <PropertyColumn Property="@(b => b.RoundId)" Title="Round" Class="text-primary-1" />
                <PropertyColumn Property="@(b => b.Admin)" Title="Banning Admin" Class="text-primary-1" />
                <TemplateColumn Title="Ban hits">
                    @if (context.HitCount > 0)
                    {
                        <NavLink href="@($"/bans/{context.Id}/hits")" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">
                            @context.HitCount
                        </NavLink>
                    }
                    else
                    {
                        <span class="text-gray-500">0</span>
                    }
                </TemplateColumn>
                <TemplateColumn Title="Actions">
                    @if (context.Active)
                    {
                        @if (!_confirmations.ContainsKey(context.Id) || !_confirmations[context.Id])
                        {
                            <button class="btn btn-secondary px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded"
                                    @onclick="() => ShowConfirmation(context.Id)">
                                Unban
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-danger px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-white"
                                    @onclick="() => ConfirmUnban(context.Id)">
                                Are you sure?
                            </button>
                        }
                    }
                    else
                    {
                        <span class="text-gray-500 italic">Already unbanned/expired</span>
                    }
                </TemplateColumn>
            </QuickGrid>
            <Pagination State="@_pagination" OnRefreshRequired="@RefreshGrid" class="py-2 border-t bg-primary-1 sticky-pagination" />
        </div>
    }
    else if (_loading)
    {
        <div class="flex items-center justify-center py-12">
            <div class="text-gray-600 dark:text-gray-400">Loading connection information...</div>
        </div>
    }
    else
    {
        <div class="flex items-center justify-center py-12">
            <div class="text-red-600 dark:text-red-400 text-xl">Connection not found</div>
        </div>
    }
</div>
